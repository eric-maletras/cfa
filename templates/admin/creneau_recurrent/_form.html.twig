{{ form_start(form, {'attr': {'class': 'creneau-form', 'id': 'creneau-form'}}) }}

<div class="form-grid">
    {# Colonne gauche #}
    <div class="form-column">
        {# Session #}
        <div class="form-section">
            <h3>Session de formation</h3>
            <div class="form-group">
                {{ form_row(form.session) }}
            </div>
        </div>

        {# Planification #}
        <div class="form-section">
            <h3>Planification</h3>
            <div class="form-row">
                <div class="form-group form-group--half">
                    {{ form_row(form.jourSemaine) }}
                </div>
                <div class="form-group form-group--half">
                    {{ form_row(form.semaineType) }}
                </div>
            </div>
            <div class="form-row">
                <div class="form-group form-group--half">
                    {{ form_row(form.heureDebut) }}
                </div>
                <div class="form-group form-group--half">
                    {{ form_row(form.heureFin) }}
                </div>
            </div>
        </div>

        {# Période de validité #}
        <div class="form-section">
            <h3>Période de validité</h3>
            <div class="form-row">
                <div class="form-group form-group--half">
                    {{ form_row(form.dateDebut) }}
                </div>
                <div class="form-group form-group--half">
                    {{ form_row(form.dateFin) }}
                </div>
            </div>
        </div>
    </div>

    {# Colonne droite #}
    <div class="form-column">
        {# Contenu pédagogique #}
        <div class="form-section">
            <h3>Contenu pédagogique</h3>
            <div class="form-group">
                {{ form_row(form.sessionMatiere) }}
            </div>
            <div class="form-group">
                {{ form_row(form.formateurs) }}
            </div>
        </div>

        {# Lieu #}
        <div class="form-section">
            <h3>Lieu</h3>
            <div class="form-group">
                {{ form_row(form.salle) }}
            </div>
        </div>

        {# Options #}
        <div class="form-section">
            <h3>Options</h3>
            <div class="form-group form-check-group">
                {{ form_row(form.actif) }}
            </div>
            <div class="form-group">
                {{ form_row(form.commentaire) }}
            </div>
        </div>
    </div>
</div>

<div class="form-actions">
    <a href="{{ path('admin_creneau_index') }}" class="btn btn--secondary">Annuler</a>
    <button type="submit" class="btn btn--primary">Enregistrer</button>
</div>

{{ form_end(form) }}

<style>
.creneau-form {
    max-width: 100%;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
}

@media (max-width: 992px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}

.form-column {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1.25rem;
}

.form-section h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    color: #333;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #4a90d9;
}

.form-row {
    display: flex;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group--half {
    flex: 1;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #4a90d9;
    box-shadow: 0 0 0 2px rgba(74, 144, 217, 0.2);
}

.form-control:disabled {
    background: #f5f5f5;
    cursor: not-allowed;
}

select.form-control {
    height: auto;
    min-height: 38px;
}

select[multiple].form-control {
    height: auto;
    min-height: 120px;
}

.form-check-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-check-input {
    width: 18px;
    height: 18px;
}

.form-check-label {
    margin-bottom: 0;
    cursor: pointer;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

.form-actions {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* Aide sous les champs */
.form-group small,
.form-group .form-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: #666;
}

/* ========================================
   MESSAGES D'ERREUR ET ALERTES
   ======================================== */

/* Erreurs de validation Symfony */
.form-group .invalid-feedback,
.form-group ul.form-errors,
.form-group .form-error-message,
.form-group ul li {
    color: #dc3545;
    font-size: 0.8rem;
    margin-top: 0.25rem;
    list-style: none;
    padding: 0;
}

.form-group ul li::before {
    content: "⚠️ ";
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-color: #fff8f8;
}

.form-control.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sessionSelect = document.querySelector('[data-dynamic-field="session"]');
    const sessionMatiereSelect = document.querySelector('[data-dynamic-target="sessionMatiere"]');
    const formateursSelect = document.querySelector('[data-dynamic-target="formateurs"]');
    const dateDebutInput = document.getElementById('{{ form.dateDebut.vars.id }}');
    const dateFinInput = document.getElementById('{{ form.dateFin.vars.id }}');
    
    // URL de base pour l'API
    const apiBaseUrl = '{{ path('admin_creneau_index') }}/api/session/';

    // Sauvegarder les valeurs initiales (mode édition)
    const initialMatiereId = sessionMatiereSelect ? sessionMatiereSelect.value : null;
    const initialFormateursIds = [];
    if (formateursSelect) {
        Array.from(formateursSelect.selectedOptions).forEach(opt => {
            initialFormateursIds.push(opt.value);
        });
    }

    function loadSessionData(sessionId, preserveValues = false) {
        if (!sessionId) {
            // Réinitialiser les champs
            if (sessionMatiereSelect) {
                sessionMatiereSelect.innerHTML = '<option value="">-- Sélectionnez d\'abord une session --</option>';
                sessionMatiereSelect.setAttribute('disabled', 'disabled');
            }
            if (formateursSelect) {
                formateursSelect.innerHTML = '<option value="">-- Sélectionnez d\'abord une session --</option>';
                formateursSelect.setAttribute('disabled', 'disabled');
            }
            return;
        }

        // Afficher un état de chargement
        if (sessionMatiereSelect) {
            sessionMatiereSelect.innerHTML = '<option value="">Chargement...</option>';
        }
        if (formateursSelect) {
            formateursSelect.innerHTML = '<option value="">Chargement...</option>';
        }

        // Charger les données de la session
        fetch(apiBaseUrl + sessionId + '/data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau');
                }
                return response.json();
            })
            .then(data => {
                console.log('Données reçues:', data);
                
                // Valeurs à sélectionner
                const matiereToSelect = preserveValues ? initialMatiereId : null;
                const formateursToSelect = preserveValues ? initialFormateursIds : [];
                
                // Mettre à jour les matières
                if (sessionMatiereSelect) {
                    sessionMatiereSelect.innerHTML = '<option value="">-- Sélectionner une matière --</option>';
                    if (data.matieres && data.matieres.length > 0) {
                        data.matieres.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m.id;
                            option.textContent = m.label;
                            // Pré-sélectionner si c'est la valeur initiale
                            if (matiereToSelect && m.id == matiereToSelect) {
                                option.selected = true;
                            }
                            sessionMatiereSelect.appendChild(option);
                        });
                    } else {
                        sessionMatiereSelect.innerHTML = '<option value="">Aucune matière disponible</option>';
                    }
                    sessionMatiereSelect.removeAttribute('disabled');
                }

                // Mettre à jour les formateurs
                if (formateursSelect) {
                    formateursSelect.innerHTML = '';
                    if (data.formateurs && data.formateurs.length > 0) {
                        data.formateurs.forEach(f => {
                            const option = document.createElement('option');
                            option.value = f.id;
                            option.textContent = f.nom;
                            // Pré-sélectionner si c'est dans les valeurs initiales
                            if (formateursToSelect.includes(f.id.toString())) {
                                option.selected = true;
                            }
                            formateursSelect.appendChild(option);
                        });
                        // Ajuster la taille du select
                        formateursSelect.size = Math.min(5, Math.max(3, data.formateurs.length));
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Aucun formateur disponible';
                        formateursSelect.appendChild(option);
                    }
                    formateursSelect.removeAttribute('disabled');
                }

                // Pré-remplir les dates si vides (uniquement si pas en mode préservation)
                if (!preserveValues) {
                    if (dateDebutInput && !dateDebutInput.value && data.session.dateDebut) {
                        dateDebutInput.value = data.session.dateDebut;
                    }
                    if (dateFinInput && !dateFinInput.value && data.session.dateFin) {
                        dateFinInput.value = data.session.dateFin;
                    }
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des données:', error);
                if (sessionMatiereSelect) {
                    sessionMatiereSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                }
                if (formateursSelect) {
                    formateursSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                }
            });
    }

    if (sessionSelect) {
        // Événement changement de session
        sessionSelect.addEventListener('change', function() {
            // Changement manuel = ne pas préserver les anciennes valeurs
            loadSessionData(this.value, false);
        });

        // Au chargement, si une session est déjà sélectionnée (mode édition)
        if (sessionSelect.value) {
            // Préserver les valeurs existantes
            loadSessionData(sessionSelect.value, true);
        }
    }
});
</script>
