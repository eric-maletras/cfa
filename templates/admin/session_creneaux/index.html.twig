{% extends 'base.html.twig' %}

{% block title %}Créneaux - {{ session.code }}{% endblock %}


{% block body %}
<div class="page-header">
    <div class="page-header-content">
        <h1>
            {% include 'icons/_icons.html.twig' with {icon: 'calendar'} %}
            Créneaux récurrents - {{ session.code }}
        </h1>
        <p class="subtitle">{{ session.formation.libelle }} ({{ session.dateDebut|date('d/m/Y') }} - {{ session.dateFin|date('d/m/Y') }})</p>
    </div>
    <div class="page-header-actions">
        <a href="{{ path('admin_session_creneaux_new', {sessionId: session.id}) }}" class="btn btn-primary">
            {% include 'icons/_icons.html.twig' with {icon: 'plus'} %}
            Nouveau créneau
        </a>
    </div>
</div>

{% for message in app.flashes('success') %}
    <div class="alert alert-success">{{ message }}</div>
{% endfor %}
{% for message in app.flashes('info') %}
    <div class="alert alert-info">{{ message }}</div>
{% endfor %}
{% for message in app.flashes('warning') %}
    <div class="alert alert-warning">{{ message }}</div>
{% endfor %}

{% if creneaux|length > 0 %}
    <div class="card mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <strong>{{ creneaux|length }}</strong> créneau(x) configuré(s)
                {% set nbActifs = creneaux|filter(c => c.actif)|length %}
                {% if nbActifs != creneaux|length %}
                    dont <strong>{{ nbActifs }}</strong> actif(s)
                {% endif %}
            </div>
            <form action="{{ path('admin_session_creneaux_generate_all', {sessionId: session.id}) }}" method="post" class="d-inline">
                <input type="hidden" name="_token" value="{{ csrf_token('generate_all' ~ session.id) }}">
                <button type="submit" class="btn btn-success">
                    {% include 'icons/_icons.html.twig' with {icon: 'refresh'} %}
                    Générer toutes les séances
                </button>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Matière</th>
                    <th>Jour</th>
                    <th>Horaires</th>
                    <th>Salle</th>
                    <th>Formateur(s)</th>
                    <th>Période</th>
                    <th>Séances</th>
                    <th>Statut</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for creneau in creneaux %}
                    {% set stat = stats[creneau.id] %}
                    <tr{% if not creneau.actif %} class="text-muted"{% endif %}>
                        <td>
                            <strong>{{ creneau.sessionMatiere.matiere.code }}</strong>
                            <br><small class="text-muted">{{ creneau.sessionMatiere.matiere.libelle|u.truncate(30) }}</small>
                        </td>
                        <td>
                            {{ creneau.jourSemaine.libelle }}
                            {% if creneau.semaineType %}
                                <br><small class="badge badge-secondary">{{ creneau.semaineType.libelleCourt }}</small>
                            {% endif %}
                        </td>
                        <td>{{ creneau.plageHoraire }}</td>
                        <td>
                            {{ creneau.salle.code }}
                            {% if creneau.salle.virtuel %}
                                <small class="badge badge-info">Virtuel</small>
                            {% endif %}
                        </td>
                        <td>
                            {% for formateur in creneau.formateurs %}
                                {{ formateur.nomComplet }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            <small>{{ creneau.dateDebut|date('d/m/Y') }}</small>
                            <br><small>{{ creneau.dateFin|date('d/m/Y') }}</small>
                        </td>
                        <td>
                            {% if stat.nbSeances > 0 %}
                                <span class="badge badge-success">{{ stat.nbSeances }}</span>
                            {% else %}
                                <span class="badge badge-secondary">0</span>
                            {% endif %}
                            {% if stat.estimation > 0 %}
                                <br><small class="text-muted">+{{ stat.estimation }} à générer</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if creneau.actif %}
                                <span class="badge badge-success">Actif</span>
                            {% else %}
                                <span class="badge badge-secondary">Inactif</span>
                            {% endif %}
                            {% if stat.nbConflits > 0 %}
                                <br><span class="badge badge-warning">{{ stat.nbConflits }} conflit(s)</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="btn-group">
                                {% if creneau.actif and stat.estimation > 0 %}
                                    <form action="{{ path('admin_session_creneaux_generate', {sessionId: session.id, id: creneau.id}) }}" method="post" class="d-inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('generate' ~ creneau.id) }}">
                                        <button type="submit" class="btn btn-sm btn-success" title="Générer">
                                            {% include 'icons/_icons.html.twig' with {icon: 'refresh'} %}
                                        </button>
                                    </form>
                                {% endif %}
                                
                                <a href="{{ path('admin_session_creneaux_preview', {sessionId: session.id, id: creneau.id}) }}" 
                                   class="btn btn-sm btn-outline-secondary" title="Prévisualiser">
                                    {% include 'icons/_icons.html.twig' with {icon: 'eye'} %}
                                </a>
                                
                                <a href="{{ path('admin_session_creneaux_edit', {sessionId: session.id, id: creneau.id}) }}" 
                                   class="btn btn-sm btn-outline-primary" title="Modifier">
                                    {% include 'icons/_icons.html.twig' with {icon: 'edit'} %}
                                </a>
                                
                                <form action="{{ path('admin_session_creneaux_delete', {sessionId: session.id, id: creneau.id}) }}" 
                                      method="post" class="d-inline"
                                      onsubmit="return confirm('Supprimer ce créneau{% if stat.nbSeances > 0 %} et ses {{ stat.nbSeances }} séance(s){% endif %} ?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ creneau.id) }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Supprimer">
                                        {% include 'icons/_icons.html.twig' with {icon: 'trash'} %}
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <p class="text-muted mb-3">Aucun créneau récurrent configuré pour cette session.</p>
            <a href="{{ path('admin_session_creneaux_new', {sessionId: session.id}) }}" class="btn btn-primary">
                {% include 'icons/_icons.html.twig' with {icon: 'plus'} %}
                Créer le premier créneau
            </a>
        </div>
    </div>
{% endif %}

<div class="mt-4">
    <a href="{{ path('admin_session_show', {id: session.id}) }}" class="btn btn-secondary">
        {% include 'icons/_icons.html.twig' with {icon: 'arrow-left'} %}
        Retour à la session
    </a>
</div>
{% endblock %}
