{% extends 'base.html.twig' %}

{% block title %}{{ user.nomComplet }}{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('css/admin.css') }}">
<style>
.inscription-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--color-background);
    border-radius: var(--border-radius);
    border-left: 4px solid var(--color-primary);
    margin-bottom: var(--spacing-sm);
}
.inscription-card--terminee {
    border-left-color: var(--color-info);
    opacity: 0.8;
}
.inscription-card--annulee,
.inscription-card--abandonnee {
    border-left-color: var(--color-danger);
    opacity: 0.6;
}
.inscription-card--en_attente {
    border-left-color: var(--color-warning);
}
.inscription-card__info {
    flex: 1;
}
.inscription-card__title {
    font-weight: var(--font-weight-semibold);
    margin-bottom: 0.25rem;
}
.inscription-card__meta {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

/* Styles sp√©cifiques formateur */
.session-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--color-background);
    border-radius: var(--border-radius);
    border-left: 4px solid var(--color-info);
    margin-bottom: var(--spacing-sm);
}
.session-card--responsable {
    border-left-color: var(--color-primary);
}
.session-card--en_cours {
    border-left-color: var(--color-success);
}
.session-card__info {
    flex: 1;
}

.devoir-mini {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--border-color);
}
.devoir-mini:last-child {
    border-bottom: none;
}

.apprenant-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--border-color);
}
.apprenant-item:last-child {
    border-bottom: none;
}
.apprenant-item__avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-sm);
}
.apprenant-item__info {
    flex: 1;
}
</style>
{% endblock %}

{% block body %}
<section class="dashboard">
    <div class="container container--narrow">
        {# En-t√™te #}
        <header class="dashboard__header">
            <div class="header-actions">
                <a href="{{ path('admin_user_index') }}" class="btn btn--secondary btn--sm">
                    ‚Üê Retour √† la liste
                </a>
            </div>
            <h1 class="dashboard__title">üë§ {{ user.nomComplet }}</h1>
            <p class="dashboard__subtitle">{{ user.email }}</p>
        </header>

        {# Informations principales #}
        <div class="tabs" style="margin-bottom: var(--spacing-xl);">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>Informations personnelles</h2>
                    <a href="{{ path('admin_user_edit', {id: user.id}) }}" class="btn btn--primary btn--sm">‚úèÔ∏è Modifier</a>
                </div>
                
                <div class="form-grid" style="margin-top: var(--spacing-lg);">
                    <div>
                        <strong>Nom complet</strong><br>
                        <span>{{ user.nomComplet }}</span>
                    </div>
                    <div>
                        <strong>Adresse email</strong><br>
                        <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                    </div>
                    <div>
                        <strong>Statut du compte</strong><br>
                        {% if user.actif %}
                            <span class="status status--success">Actif</span>
                        {% else %}
                            <span class="status status--danger">Inactif</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Date de cr√©ation</strong><br>
                        <span>{{ user.dateCreation|date('d/m/Y √† H:i') }}</span>
                    </div>
                </div>
            </div>
        </div>

        {# R√¥les et permissions #}
        <div class="tabs" style="margin-bottom: var(--spacing-xl);">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>R√¥les et permissions</h2>
                    <a href="{{ path('admin_user_roles', {id: user.id}) }}" class="btn btn--secondary btn--sm">üîê G√©rer</a>
                </div>
                
                {% if user.rolesEntities is empty %}
                    <div class="empty-state">
                        <p>‚ö†Ô∏è Aucun r√¥le attribu√© - L'utilisateur n'aura acc√®s √† aucune fonctionnalit√©.</p>
                        <a href="{{ path('admin_user_roles', {id: user.id}) }}" class="btn btn--primary btn--sm">Attribuer des r√¥les</a>
                    </div>
                {% else %}
                    <div class="form-grid" style="margin-top: var(--spacing-lg);">
                        {% for role in user.rolesEntities %}
                            <div class="tabs" style="border-left: 4px solid {{ role.code == 'ROLE_ADMIN' ? 'var(--color-danger)' : (role.code == 'ROLE_FORMATEUR' ? 'var(--color-info)' : 'var(--color-success)') }};">
                                <div class="tabs__content">
                                    <h4 style="margin-bottom: var(--spacing-sm);">
                                        <span class="badge badge--{{ role.code == 'ROLE_ADMIN' ? 'danger' : (role.code == 'ROLE_FORMATEUR' ? 'info' : 'success') }}">
                                            {{ role.libelle }}
                                        </span>
                                    </h4>
                                    {% if role.description %}
                                        <p class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">
                                            {{ role.description }}
                                        </p>
                                    {% endif %}
                                    
                                    {% if role.droits is defined and role.droits is not empty %}
                                        <details>
                                            <summary style="cursor: pointer; color: var(--color-text-secondary); font-size: var(--font-size-sm);">
                                                {{ role.droits|length }} permission(s)
                                            </summary>
                                            <ul style="margin-top: var(--spacing-sm); padding-left: var(--spacing-lg); font-size: var(--font-size-sm);">
                                                {% for droit in role.droits %}
                                                    <li class="text-muted">{{ droit.libelle }}</li>
                                                {% endfor %}
                                            </ul>
                                        </details>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        {# ========================================== #}
        {# SECTION FORMATEUR - Sessions et devoirs   #}
        {# ========================================== #}
        {% set isFormateur = false %}
        {% for role in user.rolesEntities %}
            {% if role.code == 'ROLE_FORMATEUR' %}
                {% set isFormateur = true %}
            {% endif %}
        {% endfor %}
        
        {% if isFormateur %}
            {# Sessions du formateur #}
            <div class="tabs" style="margin-bottom: var(--spacing-xl);">
                <div class="tabs__content">
                    <div class="tab-pane__header">
                        <h2>üìö Sessions de formation</h2>
                    </div>
                    
                    {% if sessions is defined and sessions|length > 0 %}
                        <div style="margin-top: var(--spacing-lg);">
                            {% for session in sessions %}
                                {% set isResponsable = session.responsable == user %}
                                {% set isEnCours = session.statut == 'en_cours' %}
                                
                                <div class="session-card {{ isResponsable ? 'session-card--responsable' : '' }} {{ isEnCours ? 'session-card--en_cours' : '' }}">
                                    <div class="session-card__info">
                                        <div class="inscription-card__title">
                                            {{ session.code }} - {{ session.libelle }}
                                            {% if isResponsable %}
                                                <span class="badge badge--primary" title="Responsable p√©dagogique">Resp.</span>
                                            {% endif %}
                                        </div>
                                        <div class="inscription-card__meta">
                                            {{ session.formation.intituleCourt ?? session.formation.intitule }}
                                            ‚Ä¢ {{ session.periodeFormatee }}
                                            ‚Ä¢ {{ session.nombreInscrits }} apprenant(s)
                                        </div>
                                    </div>
                                    <div>
                                        <span class="status status--{{ session.statut == 'en_cours' ? 'success' : (session.statut == 'planifiee' ? 'warning' : 'secondary') }}">
                                            {{ session.statutLibelle }}
                                        </span>
                                    </div>
                                    <div>
                                        <a href="{{ path('app_formateur_notes_session', {id: session.id}) }}" 
                                           class="btn btn--outline btn--sm" title="Voir les devoirs">
                                            üìù
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state" style="margin-top: var(--spacing-lg);">
                            <p>Ce formateur n'est assign√© √† aucune session.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Devoirs r√©cents du formateur #}
            <div class="tabs" style="margin-bottom: var(--spacing-xl);">
                <div class="tabs__content">
                    <div class="tab-pane__header">
                        <h2>üìù Devoirs r√©cents</h2>
                        {% if devoirs is defined and devoirs|length > 0 %}
                            <a href="{{ path('app_formateur_notes_index') }}" class="btn btn--secondary btn--sm">
                                Voir tous les devoirs
                            </a>
                        {% endif %}
                    </div>
                    
                    {% if devoirs is defined and devoirs|length > 0 %}
                        <div style="margin-top: var(--spacing-lg);">
                            {% for devoir in devoirs|slice(0, 10) %}
                                <div class="devoir-mini">
                                    <div>
                                        <strong>{{ devoir.titre }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ devoir.session.code }} ‚Ä¢ {{ devoir.dateDevoir|date('d/m/Y') }}
                                        </small>
                                    </div>
                                    <div style="text-align: right;">
                                        <span class="badge badge--{{ devoir.typeColor }}">{{ devoir.typeLibelle }}</span>
                                        <br>
                                        <small class="text-muted">
                                            {{ devoir.nombreNotesSaisies }}/{{ devoir.session.nombreInscrits }} notes
                                        </small>
                                    </div>
                                    <div>
                                        <a href="{{ path('app_formateur_notes_show', {id: devoir.id}) }}" 
                                           class="btn btn--outline btn--sm">
                                            ‚Üí
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        {# Statistiques devoirs #}
                        <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                            <div class="form-grid">
                                <div>
                                    <strong>Total devoirs :</strong> {{ devoirs|length }}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="empty-state" style="margin-top: var(--spacing-lg);">
                            <p>Ce formateur n'a pas encore cr√©√© de devoir.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Apprenants du formateur (via ses sessions) #}
            <div class="tabs" style="margin-bottom: var(--spacing-xl);">
                <div class="tabs__content">
                    <div class="tab-pane__header">
                        <h2>üë• Apprenants</h2>
                    </div>
                    
                    {% if apprenants is defined and apprenants|length > 0 %}
                        <div style="margin-top: var(--spacing-lg);">
                            {% for data in apprenants %}
                                {% set apprenant = data.user %}
                                {% set sessionApprenant = data.session %}
                                
                                <div class="apprenant-item">
                                    <div class="apprenant-item__avatar">
                                        {{ apprenant.prenom|first }}{{ apprenant.nom|first }}
                                    </div>
                                    <div class="apprenant-item__info">
                                        <strong>{{ apprenant.nom }}</strong> {{ apprenant.prenom }}
                                        <br>
                                        <small class="text-muted">
                                            {{ sessionApprenant.code }}
                                            {% if data.moyenne is not null %}
                                                ‚Ä¢ Moyenne : {{ data.moyenne|number_format(2, ',', ' ') }}/20
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div>
                                        <a href="{{ path('admin_user_show', {id: apprenant.id}) }}" 
                                           class="btn btn--outline btn--sm">
                                            ‚Üí
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        {# R√©sum√© #}
                        <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                            <div class="form-grid">
                                <div>
                                    <strong>Total apprenants :</strong> {{ apprenants|length }}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="empty-state" style="margin-top: var(--spacing-lg);">
                            <p>Aucun apprenant inscrit aux sessions de ce formateur.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {# ========================================== #}
        {# SECTION APPRENANT - Inscriptions          #}
        {# ========================================== #}
        {% set isApprenant = false %}
        {% for role in user.rolesEntities %}
            {% if role.code == 'ROLE_APPRENANT' %}
                {% set isApprenant = true %}
            {% endif %}
        {% endfor %}
        
        {% if isApprenant or (user.inscriptions is defined and user.inscriptions|length > 0) %}
        <div class="tabs" style="margin-bottom: var(--spacing-xl);">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>üìö Inscriptions aux formations</h2>
                </div>
                
                {% if user.inscriptions is not defined or user.inscriptions|length == 0 %}
                    <div class="empty-state" style="margin-top: var(--spacing-lg);">
                        <p>Cet apprenant n'est inscrit √† aucune formation.</p>
                    </div>
                {% else %}
                    <div style="margin-top: var(--spacing-lg);">
                        {% for inscription in user.inscriptions %}
                            <div class="inscription-card inscription-card--{{ inscription.statut }}">
                                <div class="inscription-card__info">
                                    <div class="inscription-card__title">
                                        {{ inscription.session.libelle }}
                                        {% if inscription.option %}
                                            <span class="badge">{{ inscription.option }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="inscription-card__meta">
                                        {{ inscription.session.formation.intituleCourt ?? inscription.session.formation.intitule }}
                                        ‚Ä¢ {{ inscription.session.periodeFormatee }}
                                    </div>
                                    {% if inscription.numeroContrat %}
                                        <div class="inscription-card__meta">
                                            Contrat : {{ inscription.numeroContrat }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="status status--{{ inscription.statutColor }}">
                                        {{ inscription.statutLibelle }}
                                    </span>
                                </div>
                                <div>
                                    <a href="{{ path('admin_inscription_index', {sessionId: inscription.session.id}) }}" 
                                       class="btn btn--outline btn--sm" title="Voir la session">
                                        ‚Üí
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {# R√©sum√© #}
                    <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                        <div class="form-grid">
                            {% set inscriptionsActives = 0 %}
                            {% set inscriptionsTerminees = 0 %}
                            {% for inscription in user.inscriptions %}
                                {% if inscription.statut == 'validee' %}
                                    {% set inscriptionsActives = inscriptionsActives + 1 %}
                                {% elseif inscription.statut == 'terminee' %}
                                    {% set inscriptionsTerminees = inscriptionsTerminees + 1 %}
                                {% endif %}
                            {% endfor %}
                            <div>
                                <strong>Total inscriptions :</strong> {{ user.inscriptions|length }}
                            </div>
                            <div>
                                <strong>En cours :</strong> {{ inscriptionsActives }}
                            </div>
                            <div>
                                <strong>Termin√©es :</strong> {{ inscriptionsTerminees }}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# Activit√© et actions #}
        <div class="tabs">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>Activit√© et actions</h2>
                </div>
                
                <div class="form-grid" style="margin-top: var(--spacing-lg);">
                    <div>
                        <strong>Derni√®re connexion</strong><br>
                        {% if user.derniereConnexion %}
                            <span>{{ user.derniereConnexion|date('d/m/Y √† H:i') }}</span>
                        {% else %}
                            <span class="text-muted">Jamais connect√©</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-actions" style="margin-top: var(--spacing-xl); flex-wrap: wrap;">
                    {# Modifier #}
                    <a href="{{ path('admin_user_edit', {id: user.id}) }}" class="btn btn--primary">
                        ‚úèÔ∏è Modifier les informations
                    </a>
                    
                    {# R√©initialiser le mot de passe #}
                    <form method="post" 
                          action="{{ path('admin_user_reset_password', {id: user.id}) }}"
                          onsubmit="return confirm('G√©n√©rer un nouveau mot de passe temporaire ?');"
                          style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('reset' ~ user.id) }}">
                        <button type="submit" class="btn btn--secondary">
                            üîë R√©initialiser le mot de passe
                        </button>
                    </form>
                    
                    {# Toggle actif #}
                    <form method="post" 
                          action="{{ path('admin_user_toggle', {id: user.id}) }}"
                          onsubmit="return confirm('{{ user.actif ? 'D√©sactiver' : 'Activer' }} ce compte ?');"
                          style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('toggle' ~ user.id) }}">
                        <button type="submit" class="btn btn--secondary">
                            {{ user.actif ? '‚è∏Ô∏è D√©sactiver' : '‚ñ∂Ô∏è Activer' }} le compte
                        </button>
                    </form>
                    
                    {# Supprimer #}
                    <form method="post" 
                          action="{{ path('admin_user_delete', {id: user.id}) }}"
                          onsubmit="return confirm('Supprimer d√©finitivement cet utilisateur ?');"
                          style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.id) }}">
                        <button type="submit" class="btn btn--danger">
                            üóëÔ∏è Supprimer
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
