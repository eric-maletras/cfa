{% extends 'base.html.twig' %}

{% block title %}{{ user.nomComplet }}{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('css/admin.css') }}">
<style>
    .session-card {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--color-background);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-sm);
        border-left: 4px solid var(--color-border);
        transition: all 0.2s ease;
    }
    
    .session-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .session-card--responsable {
        border-left-color: var(--color-primary);
        background: #e3f2fd;
    }
    
    .session-card--en_cours {
        border-left-color: var(--color-success);
    }
    
    .session-card--terminee {
        border-left-color: var(--color-secondary);
        opacity: 0.8;
    }
    
    .session-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .session-info {
        flex: 1;
        min-width: 0;
    }
    
    .session-name {
        font-weight: 600;
        margin-bottom: 2px;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }
    
    .session-meta {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }
    
    .session-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .session-badge--responsable {
        background: var(--color-primary);
        color: white;
    }
    
    .session-badge--en_cours {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .session-badge--terminee {
        background: #f5f5f5;
        color: #757575;
    }
    
    .session-badge--planifiee {
        background: #e3f2fd;
        color: #1565c0;
    }
    
    .sessions-summary {
        display: flex;
        gap: var(--spacing-lg);
        padding: var(--spacing-md);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-md);
        color: white;
        margin-bottom: var(--spacing-lg);
    }
    
    .summary-item {
        text-align: center;
        flex: 1;
    }
    
    .summary-value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .summary-label {
        font-size: 0.75rem;
        opacity: 0.9;
    }
    
    .empty-sessions {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--color-text-secondary);
    }
</style>
{% endblock %}

{% block body %}
<section class="dashboard">
    <div class="container container--narrow">
        {# En-t√™te #}
        <header class="dashboard__header">
            <div class="header-actions">
                <a href="{{ path('admin_user_index') }}" class="btn btn--secondary btn--sm">
                    ‚Üê Retour √† la liste
                </a>
            </div>
            <h1 class="dashboard__title">üë§ {{ user.nomComplet }}</h1>
            <p class="dashboard__subtitle">{{ user.email }}</p>
        </header>

        {# Messages flash #}
        {% for type, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert--{{ type }}" style="margin-bottom: var(--spacing-md);">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        {# Informations principales #}
        <div class="tabs" style="margin-bottom: var(--spacing-xl);">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>Informations personnelles</h2>
                    <a href="{{ path('admin_user_edit', {id: user.id}) }}" class="btn btn--primary btn--sm">‚úèÔ∏è Modifier</a>
                </div>
                
                <div class="form-grid" style="margin-top: var(--spacing-lg);">
                    <div>
                        <strong>Nom complet</strong><br>
                        <span>{{ user.nomComplet }}</span>
                    </div>
                    <div>
                        <strong>Adresse email</strong><br>
                        <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                    </div>
                    <div>
                        <strong>Statut du compte</strong><br>
                        {% if user.actif %}
                            <span class="status status--success">Actif</span>
                        {% else %}
                            <span class="status status--danger">Inactif</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Date de cr√©ation</strong><br>
                        <span>{{ user.dateCreation|date('d/m/Y √† H:i') }}</span>
                    </div>
                </div>
            </div>
        </div>

        {# R√¥les et permissions #}
        <div class="tabs" style="margin-bottom: var(--spacing-xl);">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>R√¥les et permissions</h2>
                    <a href="{{ path('admin_user_roles', {id: user.id}) }}" class="btn btn--secondary btn--sm">üîê G√©rer</a>
                </div>
                
                {% if user.rolesEntities is empty %}
                    <div class="empty-state">
                        <p>‚ö†Ô∏è Aucun r√¥le attribu√© - L'utilisateur n'aura acc√®s √† aucune fonctionnalit√©.</p>
                        <a href="{{ path('admin_user_roles', {id: user.id}) }}" class="btn btn--primary btn--sm">Attribuer des r√¥les</a>
                    </div>
                {% else %}
                    <div class="form-grid" style="margin-top: var(--spacing-lg);">
                        {% for role in user.rolesEntities %}
                            <div class="tabs" style="border-left: 4px solid {{ role.code == 'ROLE_ADMIN' ? 'var(--color-danger)' : (role.code == 'ROLE_FORMATEUR' ? 'var(--color-info)' : 'var(--color-success)') }};">
                                <div class="tabs__content">
                                    <h4 style="margin-bottom: var(--spacing-sm);">
                                        <span class="badge badge--{{ role.code == 'ROLE_ADMIN' ? 'danger' : (role.code == 'ROLE_FORMATEUR' ? 'info' : 'success') }}">
                                            {{ role.libelle }}
                                        </span>
                                    </h4>
                                    {% if role.description %}
                                        <p class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">
                                            {{ role.description }}
                                        </p>
                                    {% endif %}
                                    
                                    {% if role.droits is not empty %}
                                        <details>
                                            <summary style="cursor: pointer; color: var(--color-text-secondary); font-size: var(--font-size-sm);">
                                                {{ role.droits|length }} permission(s)
                                            </summary>
                                            <ul style="margin-top: var(--spacing-sm); padding-left: var(--spacing-lg); font-size: var(--font-size-sm);">
                                                {% for droit in role.droits %}
                                                    <li class="text-muted">{{ droit.libelle }}</li>
                                                {% endfor %}
                                            </ul>
                                        </details>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        {# ================================================================ #}
        {# SECTION SESSIONS - Affich√©e uniquement si l'utilisateur est formateur #}
        {# ================================================================ #}
        {% if 'ROLE_FORMATEUR' in user.roles %}
        <div class="tabs" style="margin-bottom: var(--spacing-xl);">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>üìö Promotions assign√©es</h2>
                </div>
                
                {# R√©sum√© des sessions #}
                {% set sessionsFormateur = sessions_formateur|default([]) %}
                {% set sessionsResponsable = sessions_responsable|default([]) %}
                {% set sessionsEnCours = sessionsFormateur|filter(s => s.statut == 'en_cours') %}
                
                {% if sessionsFormateur is not empty %}
                    <div class="sessions-summary">
                        <div class="summary-item">
                            <div class="summary-value">{{ sessionsFormateur|length }}</div>
                            <div class="summary-label">Promotion(s) totale(s)</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">{{ sessionsEnCours|length }}</div>
                            <div class="summary-label">En cours</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">{{ sessionsResponsable|length }}</div>
                            <div class="summary-label">En tant que responsable</div>
                        </div>
                    </div>
                    
                    {# Liste des sessions #}
                    {% for session in sessionsFormateur %}
                        {% set isResponsable = session.responsable and session.responsable.id == user.id %}
                        <div class="session-card session-card--{{ session.statut }}{% if isResponsable %} session-card--responsable{% endif %}">
                            {% if session.couleur %}
                                <span class="session-color" style="background-color: #{{ session.couleur }};"></span>
                            {% endif %}
                            <div class="session-info">
                                <div class="session-name">
                                    {{ session.libelle }}
                                    {% if isResponsable %}
                                        <span class="session-badge session-badge--responsable">‚≠ê Responsable</span>
                                    {% endif %}
                                </div>
                                <div class="session-meta">
                                    {{ session.formation.intitule }} ‚Ä¢ {{ session.periodeFormatee }}
                                    <span class="session-badge session-badge--{{ session.statut }}">
                                        {{ session.statutLibelle }}
                                    </span>
                                </div>
                            </div>
                            <a href="{{ path('admin_session_show', {id: session.id}) }}" class="btn btn--secondary btn--sm">
                                Voir
                            </a>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-sessions">
                        <p>üéì Ce formateur n'est assign√© √† aucune promotion pour le moment.</p>
                        <a href="{{ path('admin_session_index') }}" class="btn btn--primary btn--sm" style="margin-top: var(--spacing-sm);">
                            Voir les promotions
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# ================================================================ #}
        {# SECTION INSCRIPTIONS - Affich√©e uniquement si l'utilisateur est apprenti #}
        {# ================================================================ #}
        {% if 'ROLE_APPRENTI' in user.roles %}
        <div class="tabs" style="margin-bottom: var(--spacing-xl);">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>üìã Inscriptions</h2>
                </div>
                
                {% if user.inscriptions is empty %}
                    <div class="empty-sessions">
                        <p>üìù Cet apprenti n'est inscrit √† aucune formation pour le moment.</p>
                        <a href="{{ path('admin_inscription_index') }}" class="btn btn--primary btn--sm" style="margin-top: var(--spacing-sm);">
                            G√©rer les inscriptions
                        </a>
                    </div>
                {% else %}
                    {% for inscription in user.inscriptions %}
                        <div class="session-card session-card--{{ inscription.session.statut }}">
                            {% if inscription.session.couleur %}
                                <span class="session-color" style="background-color: #{{ inscription.session.couleur }};"></span>
                            {% endif %}
                            <div class="session-info">
                                <div class="session-name">
                                    {{ inscription.session.libelle }}
                                </div>
                                <div class="session-meta">
                                    {{ inscription.session.formation.intitule }} ‚Ä¢ 
                                    Inscrit le {{ inscription.dateInscription|date('d/m/Y') }}
                                    <span class="session-badge session-badge--{{ inscription.statut }}">
                                        {{ inscription.statutLibelle }}
                                    </span>
                                </div>
                            </div>
                            <a href="{{ path('admin_session_show', {id: inscription.session.id}) }}" class="btn btn--secondary btn--sm">
                                Voir
                            </a>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# Activit√© et actions #}
        <div class="tabs">
            <div class="tabs__content">
                <div class="tab-pane__header">
                    <h2>Activit√© et actions</h2>
                </div>
                
                <div class="form-grid" style="margin-top: var(--spacing-lg);">
                    <div>
                        <strong>Derni√®re connexion</strong><br>
                        {% if user.derniereConnexion %}
                            <span>{{ user.derniereConnexion|date('d/m/Y √† H:i') }}</span>
                        {% else %}
                            <span class="text-muted">Jamais connect√©</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-actions" style="margin-top: var(--spacing-xl); flex-wrap: wrap;">
                    {# Modifier #}
                    <a href="{{ path('admin_user_edit', {id: user.id}) }}" class="btn btn--primary">
                        ‚úèÔ∏è Modifier les informations
                    </a>
                    
                    {# R√©initialiser le mot de passe #}
                    <form method="post" 
                          action="{{ path('admin_user_reset_password', {id: user.id}) }}"
                          onsubmit="return confirm('G√©n√©rer un nouveau mot de passe temporaire ?');"
                          style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('reset' ~ user.id) }}">
                        <button type="submit" class="btn btn--secondary">
                            üîë R√©initialiser le mot de passe
                        </button>
                    </form>
                    
                    {# Toggle actif #}
                    <form method="post" 
                          action="{{ path('admin_user_toggle', {id: user.id}) }}"
                          onsubmit="return confirm('{{ user.actif ? 'D√©sactiver' : 'Activer' }} ce compte ?');"
                          style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('toggle' ~ user.id) }}">
                        <button type="submit" class="btn btn--secondary">
                            {{ user.actif ? '‚è∏Ô∏è D√©sactiver' : '‚ñ∂Ô∏è Activer' }} le compte
                        </button>
                    </form>
                    
                    {# Supprimer #}
                    <form method="post" 
                          action="{{ path('admin_user_delete', {id: user.id}) }}"
                          onsubmit="return confirm('Supprimer d√©finitivement cet utilisateur ?');"
                          style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.id) }}">
                        <button type="submit" class="btn btn--danger">
                            üóëÔ∏è Supprimer
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
