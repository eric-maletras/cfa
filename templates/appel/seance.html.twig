{% extends 'base.html.twig' %}

{% block title %}Appel - {{ seance.date|date('d/m/Y') }}{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('css/admin.css') }}">
<style>
/* ========================================
   PAGE CR√âATION APPEL
   ======================================== */

.appel-header {
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: white;
    padding: 2rem;
    border-radius: var(--border-radius-lg);
    margin-bottom: 1.5rem;
}

.appel-header__title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.appel-header__subtitle {
    opacity: 0.9;
}

/* Formulaire appel */
.appel-form {
    background: white;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.appel-form__header {
    padding: 1.25rem;
    background: var(--color-off-white);
    border-bottom: 1px solid var(--border-color);
}

.appel-form__title {
    font-weight: 600;
    margin: 0;
}

.appel-form__body {
    padding: 1.5rem;
}

/* Liste des apprentis */
.apprentis-list {
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    max-height: 500px;
    overflow-y: auto;
    margin-bottom: 1.5rem;
}

.apprenti-row {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    gap: 1rem;
    transition: background 0.2s;
}

.apprenti-row:last-child {
    border-bottom: none;
}

.apprenti-row:hover {
    background: var(--color-off-white);
}

.apprenti-row__checkbox {
    flex-shrink: 0;
}

.apprenti-row__checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.apprenti-row__avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
}

.apprenti-row__info {
    flex: 1;
}

.apprenti-row__name {
    font-weight: 500;
}

.apprenti-row__email {
    font-size: 0.85rem;
    color: var(--color-text-muted);
}

/* Options */
.appel-options {
    background: var(--color-off-white);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
}

.appel-options__title {
    font-weight: 600;
    margin-bottom: 0.75rem;
}

.option-group {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.option-group label {
    font-weight: 500;
}

.option-group select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-family: inherit;
}

/* Actions */
.appel-actions {
    display: flex;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

/* S√©lection rapide */
.selection-rapide {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.selection-rapide button {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    background: white;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
}

.selection-rapide button:hover {
    background: var(--color-off-white);
    border-color: var(--color-primary);
}

/* Info box */
.info-box {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    font-size: 0.9rem;
}

/* Compteur */
.compteur {
    font-size: 0.9rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
}

.compteur strong {
    color: var(--color-primary);
}

/* ========================================
   ALERTE HORS HORAIRES
   ======================================== */
.alert-horaire {
    background: #fff3e0;
    border-left: 4px solid #ff9800;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.alert-horaire__icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.alert-horaire__content {
    flex: 1;
}

.alert-horaire__title {
    font-weight: 600;
    color: #e65100;
    margin-bottom: 0.25rem;
}

.alert-horaire__text {
    color: #bf360c;
    font-size: 0.9rem;
}

/* Formulaire d√©sactiv√© */
.appel-form--disabled {
    opacity: 0.6;
    pointer-events: none;
    user-select: none;
}

.appel-form--disabled .apprenti-row:hover {
    background: transparent;
}

/* Bouton d√©sactiv√© */
.btn--disabled {
    background: #ccc !important;
    border-color: #ccc !important;
    color: #666 !important;
    cursor: not-allowed !important;
    pointer-events: none;
}
</style>
{% endblock %}

{% block body %}
<section class="dashboard">
    <div class="container">
        {# Navigation retour #}
        <header class="dashboard__header">
            <div class="header-actions">
                <a href="{{ path('app_formateur_planning_seance', {id: seance.id}) }}" class="btn btn--secondary btn--sm">
                    ‚Üê Retour √† la s√©ance
                </a>
            </div>
        </header>

        {# En-t√™te #}
        <div class="appel-header">
            <h1 class="appel-header__title">üìã Faire l'appel</h1>
            <p class="appel-header__subtitle">
                {% if seance.sessionMatiere and seance.sessionMatiere.matiere %}
                    {{ seance.sessionMatiere.matiere.libelle }} - 
                {% endif %}
                {{ seance.date|date('d/m/Y') }} de {{ seance.heureDebut|date('H:i') }} √† {{ seance.heureFin|date('H:i') }}
                {% if seance.salle %}
                    - Salle {{ seance.salle.libelle }}
                {% endif %}
            </p>
        </div>

        {# Messages flash #}
        {% for message in app.flashes('success') %}
            <div class="alert alert--success">{{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('error') %}
            <div class="alert alert--danger">{{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('warning') %}
            <div class="alert alert--warning">{{ message }}</div>
        {% endfor %}

        {# Alerte si hors horaires #}
        {% if not seanceEnCours %}
            <div class="alert-horaire">
                <span class="alert-horaire__icon">‚è∞</span>
                <div class="alert-horaire__content">
                    <div class="alert-horaire__title">Appel impossible actuellement</div>
                    <div class="alert-horaire__text">
                        L'appel ne peut √™tre effectu√© que pendant le cr√©neau du cours, 
                        soit entre <strong>{{ seance.heureDebut|date('H:i') }}</strong> 
                        et <strong>{{ seance.heureFin|date('H:i') }}</strong>.
                    </div>
                </div>
            </div>
        {% endif %}

        {# Info box #}
        {% if seanceEnCours %}
        <div class="info-box">
            <strong>üìù Instructions :</strong><br>
            1. Cochez les apprentis <strong>physiquement pr√©sents</strong> dans la salle<br>
            2. Les apprentis non coch√©s seront marqu√©s <strong>absents</strong><br>
            3. Un email de signature sera envoy√© aux pr√©sents pour confirmer leur pr√©sence
        </div>
        {% endif %}

        {% if apprentis|length > 0 %}
            {# Formulaire de cr√©ation d'appel #}
            <form action="{{ path('app_appel_creer', {id: seance.id}) }}" method="post" id="form-appel">
                <input type="hidden" name="_token" value="{{ csrf_token('appel_creer_' ~ seance.id) }}">
                
                <div class="appel-form {{ not seanceEnCours ? 'appel-form--disabled' : '' }}">
                    <div class="appel-form__header">
                        <h2 class="appel-form__title">üë• Liste des apprentis inscrits</h2>
                    </div>
                    <div class="appel-form__body">
                        {# S√©lection rapide #}
                        <div class="selection-rapide">
                            <button type="button" onclick="selectionnerTous()" {{ not seanceEnCours ? 'disabled' : '' }}>‚úÖ Tous pr√©sents</button>
                            <button type="button" onclick="deselectionnerTous()" {{ not seanceEnCours ? 'disabled' : '' }}>‚ùå Aucun pr√©sent</button>
                        </div>

                        {# Compteur #}
                        <div class="compteur">
                            <strong id="compteur-presents">0</strong> pr√©sent(s) / {{ apprentis|length }} apprenti(s)
                        </div>

                        {# Liste des apprentis #}
                        <div class="apprentis-list">
                            {% for apprenti in apprentis %}
                                <div class="apprenti-row">
                                    <div class="apprenti-row__checkbox">
                                        <input type="checkbox" 
                                               name="apprentis_presents[]" 
                                               value="{{ apprenti.id }}"
                                               id="apprenti-{{ apprenti.id }}"
                                               class="checkbox-apprenti"
                                               {{ not seanceEnCours ? 'disabled' : '' }}>
                                    </div>
                                    <label for="apprenti-{{ apprenti.id }}" class="apprenti-row__avatar">
                                        {{ apprenti.prenom|first|upper }}{{ apprenti.nom|first|upper }}
                                    </label>
                                    <label for="apprenti-{{ apprenti.id }}" class="apprenti-row__info" style="cursor: pointer;">
                                        <div class="apprenti-row__name">
                                            {{ apprenti.nom|upper }} {{ apprenti.prenom }}
                                        </div>
                                        <div class="apprenti-row__email">
                                            {{ apprenti.email }}
                                        </div>
                                    </label>
                                </div>
                            {% endfor %}
                        </div>

                        {# Options #}
                        <div class="appel-options">
                            <div class="appel-options__title">‚öôÔ∏è Options</div>
                            <div class="option-group">
                                <label for="expiration_minutes">Dur√©e de validit√© des liens :</label>
                                <select name="expiration_minutes" id="expiration_minutes" {{ not seanceEnCours ? 'disabled' : '' }}>
                                    <option value="15">15 minutes</option>
                                    <option value="20" selected>20 minutes (recommand√©)</option>
                                    <option value="40">40 minutes</option>
                                </select>
                            </div>
                        </div>

                        {# Actions #}
                        <div class="appel-actions">
                            <a href="{{ path('app_formateur_planning_seance', {id: seance.id}) }}" class="btn btn--secondary">
                                Annuler
                            </a>
                            {% if seanceEnCours %}
                                <button type="submit" class="btn btn--primary">
                                    üìß Cr√©er l'appel et envoyer les emails
                                </button>
                            {% else %}
                                <button type="button" class="btn btn--primary btn--disabled" disabled title="L'appel ne peut √™tre fait que pendant le cours">
                                    üîí Appel indisponible (hors horaires)
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        {% else %}
            <div class="appel-form">
                <div class="appel-form__body" style="text-align: center; padding: 3rem;">
                    <p style="font-size: 1.1rem; color: var(--color-text-muted);">
                        üòï Aucun apprenti inscrit √† cette session.
                    </p>
                    <a href="{{ path('app_formateur_planning_seance', {id: seance.id}) }}" class="btn btn--secondary" style="margin-top: 1rem;">
                        ‚Üê Retour √† la s√©ance
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block javascripts %}
<script>
// Mise √† jour du compteur
function updateCompteur() {
    const total = document.querySelectorAll('.checkbox-apprenti').length;
    const checked = document.querySelectorAll('.checkbox-apprenti:checked').length;
    document.getElementById('compteur-presents').textContent = checked;
}

// S√©lectionner tous
function selectionnerTous() {
    document.querySelectorAll('.checkbox-apprenti:not(:disabled)').forEach(cb => {
        cb.checked = true;
    });
    updateCompteur();
}

// D√©s√©lectionner tous
function deselectionnerTous() {
    document.querySelectorAll('.checkbox-apprenti:not(:disabled)').forEach(cb => {
        cb.checked = false;
    });
    updateCompteur();
}

// √âv√©nements sur les checkboxes
document.querySelectorAll('.checkbox-apprenti').forEach(cb => {
    cb.addEventListener('change', updateCompteur);
});

// Initialiser le compteur
updateCompteur();

// Confirmation avant envoi
document.getElementById('form-appel')?.addEventListener('submit', function(e) {
    const checked = document.querySelectorAll('.checkbox-apprenti:checked').length;
    const total = document.querySelectorAll('.checkbox-apprenti').length;
    const absents = total - checked;
    
    if (checked === 0) {
        if (!confirm('Aucun apprenti n\'est coch√© comme pr√©sent.\n\nTous les apprentis seront marqu√©s ABSENTS.\n\nContinuer ?')) {
            e.preventDefault();
        }
    } else if (absents > 0) {
        if (!confirm(`${checked} apprenti(s) coch√©(s) pr√©sent(s).\n${absents} apprenti(s) seront marqu√©(s) ABSENT(S).\n\nContinuer ?`)) {
            e.preventDefault();
        }
    }
});
</script>
{% endblock %}
